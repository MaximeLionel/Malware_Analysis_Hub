# Static Data
* source of malware: lab07-01 of book 'practical malware analysis'.
* md5,C04FD8D9198095192E7D55345966DA2E
* sha1,86EE262230CBF6F099B6086089DA9EB9075B4521
* sha256,0C98769E42B364711C478226EF199BFBBA90DB80175EB1B8CD565AA694C09852
* no pack: signature,Microsoft Visual C++ v6.0
* The file references a URL pattern,url: http://www.malwareanalysisbook.com,1
* wininet.dll,0x40C0,0x4544,implicit,2,Internet Extensions for Win32
* TerminateProcess,0x29E,0x46C6,execution,implicit,-,x,kernel32.dll
* GetEnvironmentStrings,0x106,0x4740,execution,implicit,-,x,kernel32.dll
* ascii,26,0x00004644,x,-,services,StartServiceCtrlDispatcher
* ascii,13,0x00004655,x,-,services,CreateService
* ascii,15,0x00004689,x,-,network,InternetOpenUrl
* ascii,12,0x0000469A,x,-,network,InternetOpen
* ascii,16,0x000046D9,x,import,execution,TerminateProcess
* ascii,21,0x00004758,x,import,execution,GetEnvironmentStrings
* ascii,21,0x00004771,x,import,execution,GetEnvironmentStrings
  
# Dynamic Data
* wireshark - contact  www.malwareanalysisbook.com.
```
    1	0.000000000	192.168.190.129	192.168.190.1	DNS	76	Standard query 0x9669 A wpad.localdomain
    2	0.564506823	192.168.190.129	192.168.190.1	DNS	85	Standard query 0xa213 A msedgesetup.azureedge.net
    7	2.000635096	192.168.190.129	192.168.190.1	DNS	76	Standard query 0x9669 A wpad.localdomain
    16	3.853336041	192.168.190.129	239.255.255.250	SSDP	216	M-SEARCH * HTTP/1.1 
    18	4.582235696	192.168.190.129	192.168.190.1	DNS	85	Standard query 0xa213 A msedgesetup.azureedge.net
    19	4.863551779	192.168.190.129	239.255.255.250	SSDP	216	M-SEARCH * HTTP/1.1 
    20	4.884643144	192.168.190.129	192.168.190.1	DNS	88	Standard query 0xcd91 PTR 250.255.255.239.in-addr.arpa
    21	4.912712114	192.168.190.129	192.168.190.1	DNS	88	Standard query 0xcd91 PTR 250.255.255.239.in-addr.arpa
    22	5.866571604	192.168.190.129	239.255.255.250	SSDP	216	M-SEARCH * HTTP/1.1 
    23	5.928659188	192.168.190.129	192.168.190.1	DNS	88	Standard query 0xcd91 PTR 250.255.255.239.in-addr.arpa
    27	6.880501277	192.168.190.129	239.255.255.250	SSDP	216	M-SEARCH * HTTP/1.1 
    31	7.764210786	192.168.190.129	192.168.190.1	DNS	87	Standard query 0x5320 A www.malwareanalysisbook.com
    32	7.785840508	192.168.190.129	192.168.190.1	DNS	87	Standard query 0x5320 A www.malwareanalysisbook.com
    33	7.941045295	192.168.190.129	192.168.190.1	DNS	88	Standard query 0xcd91 PTR 250.255.255.239.in-addr.arpa
    35	8.800022763	192.168.190.129	192.168.190.1	DNS	87	Standard query 0x5320 A www.malwareanalysisbook.com
    36	10.819810321	192.168.190.129	192.168.190.1	DNS	87	Standard query 0x5320 A www.malwareanalysisbook.com
    40	11.940630538	192.168.190.129	192.168.190.1	DNS	88	Standard query 0xcd91 PTR 250.255.255.239.in-addr.arpa
    44	14.831078892	192.168.190.129	192.168.190.1	DNS	87	Standard query 0x5320 A www.malwareanalysisbook.com
    45	15.946956475	192.168.190.129	239.255.255.250	NBNS	92	Name query NBSTAT *<00><00><00><00><00><00><00><00><00><00><00><00><00><00><00>
    47	15.947575493	192.168.190.129	224.0.0.252	LLMNR	88	Standard query 0xc569 PTR 250.255.255.239.in-addr.arpa
    49	16.365984721	192.168.190.129	224.0.0.252	LLMNR	88	Standard query 0xc569 PTR 250.255.255.239.in-addr.arpa`
```
* procmon - create lab07-01 process.

# IDA 
1. connect main thread (service_main) of a service process to the sc manager, so that the 'MalService' will start everytime the system boots up.
   * ServiceStartTable.lpServiceName = "Malservice".
   * ServiceStartTable.lpServiceProc = service_main.
  ```
    lea     eax, [esp+10h+ServiceStartTable]
    mov     [esp+10h+ServiceStartTable.lpServiceName], offset aMalservice ; "MalService"
    push    eax             ; lpServiceStartTable
    mov     [esp+14h+ServiceStartTable.lpServiceProc], offset service_main
    mov     [esp+14h+var_8], 0
    mov     [esp+14h+var_4], 0
    call    ds:StartServiceCtrlDispatcherA
  ```
2. enter service_main and open mutex to make sure there's one MalService running.
3. get the module name of current process and create a service called 'MalService'.
4. create a timer object and wait until 2100.1.1 00:00 to signal the timer.
   ```
    mov     dword ptr [esp+404h+SystemTime.wYear], edx
    lea     ecx, [esp+404h+SystemTime]
    mov     dword ptr [esp+404h+SystemTime.wDayOfWeek], edx
    push    eax             ; lpFileTime
    mov     dword ptr [esp+408h+SystemTime.wHour], edx
    push    ecx             ; lpSystemTime
    mov     dword ptr [esp+40Ch+SystemTime.wSecond], edx
    mov     [esp+40Ch+SystemTime.wYear], 2100
    call    ds:SystemTimeToFileTime ; convert a system time to file time format.
   ```
5. after the timer is signaled on 2100.1.1, the malware starts to create 20 threads. After the creation, the current thread is going to sleep infinitely.
6. enter the code starting address of the new thread. it sends many requests to http://www.malwareanalysisbook.com.

# Summary
this malware will make itself as a service and run automatically when system bootup. On 2100.1.1 00:00, it will create 20 threads and keep sending many requests to http://www.malwareanalysisbook.com. Finally, it will cause a DDoS attack.
   
   